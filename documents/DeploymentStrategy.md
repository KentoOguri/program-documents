# デプロイ戦略
## デプロイ戦略とは
効率的かつ安全に、リスクを最小にしながらシステムを本番環境にリリースする戦略

## デプロイ戦略がなぜ大切なのか
デプロイ戦略を事前に考慮したシステム設計をすることで、次のようなメリットがある

### リスク管理
システム障害やサービス停止のリスクを最小限にできる

### ユーザ体験
サービスを利用していて急に使えなくなることがない仕組みでサービスを提供できる

### ビジネスの継続性
24時間365日稼働させるシステムの、サービス停止時間を最小化できる

### 品質保証
段階的なデプロイにより、問題の早期発見

# 主なデプロイ戦略
## Blue/Green デプロイメント
本番環境（Blue）と同じ構成の待機環境(Green)を作成する
新バージョンをGreen環境にデプロイ後、接続先をBlue環境からGreen環境に切り替える手法

### 特徴
- ダウンタイムがほぼゼロ
- 旧環境から新環境へ瞬時に切り替え可能
- 問題発生時、ロールバックでデプロイ前の状態に戻すことが可能
- インフラ環境的に問題がある場合、デプロイが失敗し新環境が本番環境にデプロイされることがない

### どういったケースで有効？
- ダウンタイムを発生させたくない場合
- 大規模なシステムの更新

**ダウンタイムを発生させたくない場合**  
数分のダウンタイムを許したくないシステムに対して、Blue/Greenデプロイメントは瞬時に環境を切り替えることができるため効果的

**大規模なシステムの更新**  
工数の高い対応や複雑な対応で段階的なデプロイが困難な場合、
インフラ的な問題があればデプロイされることはなく、一括でデプロイが短時間で実行できるため効果的

### デメリット
- 一時的に2倍のリソースを必要とするため、リソース制限を強く求める場合は取り入れることが難しい
- インフラの管理がやや複雑になる

ただし、ECサイトで1時間のダウンタイムが100万円の損失を生む場合、数万円の追加インフラコストでダウンタイムを回避できるBlue/Greenデプロイは十分に投資対効果があると言える

## カナリアデプロイ
新バージョンを一部のユーザやサーバのみに展開し、段階的に拡大していく手法

### 特徴
- 小規模から段階的に展開範囲を拡大
- 問題の早期発見と影響範囲の限定が可能
- ユーザーフィードバックの収集が容易
- A/Bテストを試験的に導入するのに適した環境

### どういったケースで有効？
- 新機能の段階的リリース
- 高頻度でのデプロイ

**新機能の段階的リリース**  
新機能の影響を限定的に確認したい場合、一部ユーザーに先行提供して反応を見ながら展開できるため効果的

**高頻度でのデプロイ**  
継続的インテグレーション/デプロイメント環境で、小さな変更を頻繁にリリースする場合、リスクを抑えながら迅速にデプロイできるため効果的

### デメリット
- 新旧バージョンが混在するため、データ整合性の管理が複雑
- 監視とメトリクス収集の仕組みが複雑になる
- ユーザーごとに異なる体験を提供するため、サポート対応が困難
- 段階的な展開に時間がかかる場合がある

## ローリングデプロイメント
複数のサーバーを順次アップデートしていく手法

### 特徴
- 追加インフラが不要でコスト効率が良い
- サービスの継続性を維持
- 段階的な問題の発見と対処が可能
- 一部サーバーで問題が発生してもサービス全体は継続

### どういったケースで有効？
- コスト制約がある場合

**コスト制約がある場合**  
Blue/Greenのような追加インフラを用意できない場合、既存のサーバーを順次更新することでコストを抑えながらデプロイできるため効果的


### デメリット
- デプロイ中に新旧バージョンが混在するため、互換性の問題が発生する可能性
- デプロイに時間がかかる場合がある
- 一部のサーバーで問題が発生した場合、影響の切り分けが困難
- データベーススキーマ変更など、大規模な変更には適さない

## インプレースデプロイ
既存の本番環境で直接アプリケーションを更新する手法

### 特徴
- 最もシンプルで理解しやすい
- 追加リソースが不要
- デプロイ時間が短い
- ダウンタイムが発生する可能性が高い

### どういったケースで有効？
- 小規模なシステム
- 緊急時の修正

**小規模なシステム**  
ユーザー数が少なく短時間のダウンタイムが許容できるシステムで、複雑なデプロイ戦略を導入するコストが見合わない場合に効果的

**緊急時の修正**  
セキュリティパッチなどの迅速な対応が最優先で複雑な手順を踏む時間がない場合、最短でデプロイを実行できるため効果的

### デメリット
- サービスダウンタイムが発生する
- デプロイ失敗時の影響が大きい
- ロールバックに時間がかかる
- 本番環境で直接作業を行うため、予期しない問題が発生するリスクが高い

# Blue/GreenデプロイメントのECS料金計算サンプル

## 前提条件（小規模ECSシステム）

### 構成例
```
- ECSクラスター: 1個
- ECSサービス: 2個（Web、API）
- タスク数: Web 2タスク、API 2タスク
- インスタンスタイプ: t3.medium相当
- ALB: 1個
- RDS: db.t3.micro（1個）
- リージョン: ap-northeast-1（東京）
```

## 通常運用時の月額コスト

### ECS Fargate
```
Web: 0.25vCPU × 0.5GB × 2タスク × 720時間
料金: $0.04048/vCPU/時間 + $0.004445/GB/時間

Web: (0.25 × $0.04048 + 0.5 × $0.004445) × 2 × 720
   = ($0.01012 + $0.002223) × 2 × 720
   = $17.78/月

API: 同様の構成で $17.78/月

ECS合計: $35.56/月 (約5,330円)
```

### Application Load Balancer
```
ALB基本料金: $0.0225/時間 × 720時間 = $16.2/月
LCU料金: 小規模なので約$5/月
ALB合計: $21.2/月 (約3,180円)
```

### RDS
```
db.t3.micro: $0.017/時間 × 720時間 = $12.24/月 (約1,840円)
```

### 通常運用合計
```
約10,350円/月
```

## Blue/Greenデプロイ時の追加コスト

### Green環境で必要なリソース
```
- ECS Fargate: 同じ構成 (約5,330円/月相当)
- ALB: 既存のものを流用（追加コストなし）
- RDS: データコピー用の一時インスタンス (約1,840円/月相当)
```

### デプロイ実行時間別コスト
TODO